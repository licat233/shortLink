"use strict";function App(){this.totalE=document.getElementById("total"),this.genbtnE=document.getElementById("genbtn"),this.lineidE=document.getElementById("lineid"),this.genmsgE=document.getElementById("genmsg"),this.notebook_ulE=document.getElementById("notebook_ul"),this.queryE=document.getElementById("query"),this.orderListE=document.getElementById("orderList"),this.NewLinkInfo=function(line,link,createAt){return{Status:!1,Count:0,LineId:line,ShortLink:link,Prize:null,LuckDate:"",CreatedAt:createAt}},this.alertMsg=(name,msg)=>{this.genmsgE.className=name,this.genmsgE.innerHTML=msg},this.showStyle=ele=>{var lastE=document.querySelector(".showAnimate");lastE&&(lastE.className="card card-4",lastE=null),ele.className="card card-3 showAnimate",ele.style.display=""},this.genNotebook=info=>{var PrizeName=info.Prize&&info.Prize.Name||"",imgTmp="";info.Prize&&info.Prize.Image&&(imgTmp=`<img class="prizeImg" src="${info.Prize.Image}" alt="">`);var htmlTmp=` 獎品: ${PrizeName}<br/>\n                    抽獎時間: ${info.LuckDate.substring(0,19)}<br/>\n                    LineID: ${info.LineId}<br />\n                    短鏈接: ${info.ShortLink}<br />\n                    創建時間: ${info.CreatedAt.substring(0,19)}\n                    <div class="right top">\n                        ${imgTmp}\n                    </div>`,liEle=document.createElement("li");return liEle.className="card card-4",liEle.innerHTML=htmlTmp,liEle},this.genListNotebook=data=>{for(var len=data.length,fragmentE=document.createDocumentFragment(),i=0;i<len;i++){var info=data[i];fragmentE.appendChild(this.genNotebook(info))}this.notebook_ulE.appendChild(fragmentE)},this.lineidVerify=()=>0===this.lineidE.value.trim().length?(this.lineidE.className="errorInput",this.alertMsg("error","請輸入LineID"),setTimeout(()=>{this.lineidE.className="",this.alertMsg("","")},3e3),!1):this.lineidE.value.trim().length<4?(this.lineidE.className="errorInput",this.alertMsg("error","輸入LineID長度小於4"),!1):this.lineidE.value.trim().length>8?(this.lineidE.className="errorInput",this.alertMsg("error","輸入LineID長度大於8"),!1):(this.lineidE.className="",this.alertMsg("",""),!0),this.genShortlink=()=>{if("on"!==this.genbtnE.dataset.state){this.genmsgE.className="",this.genbtnE.dataset.state="on";var lineid=this.lineidE.value.trim();if(this.lineidVerify())if(Auth()){var myHeaders=new Headers;myHeaders.append("Authorization",window.jwtToken.Token),myHeaders.append("Content-Type","text/plain");var raw,requestOptions={method:"POST",headers:myHeaders,body:JSON.stringify({LineID:lineid}),redirect:"follow"};window.fetch?fetch("/luck/admin/genlink",requestOptions).then(response=>response.json()).then(result=>{if(result.code)if(200===result.code){var num=Number(this.totalE.innerText);0===num&&(this.notebook_ulE.className="",this.notebook_ulE.innerHTML=""),this.totalE.innerText=num+1,this.alertMsg("success",result.data.ShortLink);var info=this.NewLinkInfo(result.data.LineId,result.data.ShortLink,result.data.CreatedAt),nodeE=this.genNotebook(info);window.links.data.push(info),window.links.total++,nodeE.style.display="none",this.notebook_ulE.insertAdjacentElement("afterbegin",nodeE),this.showStyle(nodeE)}else 401===result.code?this.alertMsg("warning",result.message):this.alertMsg("error",result.message);else this.alertMsg("error","服務器錯誤！")}).catch(error=>{console.log("error",error),this.alertMsg("error","程序出錯,請聯繫管理員")}).finally(()=>{this.genbtnE.dataset.state="off"}):alert("當前瀏覽器不支持fetch,請更換瀏覽器後重試！")}else alert(window.loginState);else this.genbtnE.dataset.state="off"}},this.requestData=callback=>{var myHeaders=new Headers,requestOptions;myHeaders.append("Authorization",window.jwtToken.Token),fetch("http://127.0.0.1:81/luck/admin/shortlinks",{method:"POST",headers:myHeaders,redirect:"follow"}).then(response=>response.json()).then(result=>{if(result.code)if(200===result.code){if(0===result.data.length)return this.notebook_ulE.className="warning",void(this.notebook_ulE.innerHTML="當前無記錄");callback(result)}else 401===result.code?(this.notebook_ulE.className="warning",this.notebook_ulE.innerHTML=result.message):(this.notebook_ulE.className="error",this.notebook_ulE.innerHTML=result.message);else this.notebook_ulE.className="error",this.notebook_ulE.innerHTML="服務器錯誤！"}).catch(error=>{console.log("error",error),this.notebook_ulE.className="error",this.notebook_ulE.innerHTML="程序出錯,請聯繫管理員"})},this.matchedInfo=function(search){for(var reg=new RegExp(search),len=window.links.data.length,result=[],i=0;i<len;i++)(reg.test(window.links.data[i].LineId)||reg.test(window.links.data[i].ShortLink))&&result.push(window.links.data[i]);return result},this.queryHandler=()=>{var content=this.queryE.value.trim();if(0===content.length)return this.totalE.innerText=window.links.total,void this.genListNotebook(window.links.data);var result=this.matchedInfo(content);this.notebook_ulE.innerHTML="",this.totalE.innerText=result.length,this.genListNotebook(result)},this.bubbleSort=(arr,order)=>{var len=arr.length;if(!(len<2)){var compareFn,temp,before,after;if("asc"===order)compareFn=(a,b)=>a<b;else{if("desc"!==order)return;compareFn=(a,b)=>a>b}for(var i=len;i>1;i--)for(var j=1;j<i;j++)before=arr[j-1],after=arr[j],compareFn(new Date(before.CreatedAt.substring(0,19)),new Date(after.CreatedAt.substring(0,19)))&&(temp=before,arr[j-1]=after,arr[j]=temp)}},this.orderListHandler=()=>{this.bubbleSort(window.links.data,this.orderListE.value),this.notebook_ulE.innerHTML="",this.genListNotebook(window.links.data)},this.animateButton=function(){this.genbtnE.classList.remove("animate"),this.genbtnE.classList.add("animate"),setTimeout(()=>{this.genbtnE.classList.remove("animate")},700)},this.initialize=()=>{window.links={total:0,data:[]},this.requestData(result=>{window.links.data=result.data,window.links.total=result.total,this.totalE.innerText=result.total,this.bubbleSort(window.links.data,"asc"),this.genListNotebook(window.links.data)})},this.Run=()=>{var timer;this.initialize(),this.queryE.addEventListener("input",()=>{clearTimeout(timer),timer=setTimeout(this.queryHandler,300)}),this.lineidE.addEventListener("change",()=>{this.lineidVerify()}),this.genbtnE.addEventListener("click",()=>{this.animateButton(),this.genShortlink()},!1),this.orderListE.addEventListener("change",this.orderListHandler)}}(new App).Run();